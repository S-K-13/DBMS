-- ============================================================
-- PROBLEM STATEMENT – 8  (MySQL, Ubuntu terminal)
-- Goal:
--   * Student DB with: student_id, student_name, class, address,
--     grades, enrolment details, subject name, attendance
--   * Create VIEWS for performance & attendance
--   * Create "sequence" for unique student IDs (MySQL uses AUTO_INCREMENT)
--   * Create an INDEX on student name
-- ============================================================

-- Fresh workspace
DROP DATABASE IF EXISTS student_ps8;
CREATE DATABASE student_ps8;
USE student_ps8;

-- ======================
-- 1) Core Tables
-- ======================

-- "Sequence" for student IDs in MySQL = AUTO_INCREMENT
CREATE TABLE students (
  student_id     INT PRIMARY KEY AUTO_INCREMENT,
  student_name   VARCHAR(60) NOT NULL,
  class          VARCHAR(20),
  address        VARCHAR(120),
  enrollment_date DATE DEFAULT (CURDATE())
);

CREATE TABLE subjects (
  subject_id   INT PRIMARY KEY AUTO_INCREMENT,
  subject_name VARCHAR(60) NOT NULL UNIQUE
);

-- Enrollment details (which student takes which subject)
CREATE TABLE enrollments (
  student_id INT,
  subject_id INT,
  PRIMARY KEY (student_id, subject_id),
  FOREIGN KEY (student_id) REFERENCES students(student_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  FOREIGN KEY (subject_id) REFERENCES subjects(subject_id)
    ON UPDATE CASCADE ON DELETE CASCADE
);

-- Grades per student per subject (0–100 for simplicity)
CREATE TABLE grades (
  student_id INT,
  subject_id INT,
  marks      INT CHECK (marks BETWEEN 0 AND 100),
  PRIMARY KEY (student_id, subject_id),
  FOREIGN KEY (student_id, subject_id) REFERENCES enrollments(student_id, subject_id)
    ON UPDATE CASCADE ON DELETE CASCADE
);

-- Attendance per student per subject
CREATE TABLE attendance (
  student_id    INT,
  subject_id    INT,
  total_classes INT CHECK (total_classes >= 0),
  attended      INT CHECK (attended >= 0),
  PRIMARY KEY (student_id, subject_id),
  FOREIGN KEY (student_id, subject_id) REFERENCES enrollments(student_id, subject_id)
    ON UPDATE CASCADE ON DELETE CASCADE
);

-- ======================
-- 2) Sample Data
-- ======================

-- Students (IDs auto-generated via AUTO_INCREMENT)
INSERT INTO students (student_name, class, address) VALUES
('Rohan', 'SE', 'Pune'),
('Priya', 'SE', 'Mumbai'),
('Aditi', 'TE', 'Nashik'),
('Manav', 'TE', 'Pune');

INSERT INTO subjects (subject_name) VALUES ('Math'), ('Science'), ('English');

-- Enrollments
INSERT INTO enrollments VALUES
(1,1),(1,2),(1,3),      -- Rohan: all 3
(2,1),(2,2),            -- Priya: Math, Science
(3,2),(3,3),            -- Aditi: Science, English
(4,1);                  -- Manav: Math

-- Grades (marks out of 100)
INSERT INTO grades VALUES
(1,1,78),(1,2,85),(1,3,72),
(2,1,88),(2,2,63),
(3,2,91),(3,3,80),
(4,1,66);

-- Attendance (total & attended)
INSERT INTO attendance VALUES
(1,1,30,27),(1,2,28,25),(1,3,26,20),
(2,1,30,28),(2,2,28,18),
(3,2,28,26),(3,3,26,22),
(4,1,30,19);

-- ======================
-- 3) Views (performance & attendance insights)
-- ======================

-- a) Attendance view: per student per subject with percentage
CREATE OR REPLACE VIEW v_student_attendance AS
SELECT
  s.student_id,
  s.student_name,
  sub.subject_name,
  a.attended,
  a.total_classes,
  ROUND(100.0 * a.attended / NULLIF(a.total_classes,0), 2) AS attendance_pct
FROM attendance a
JOIN enrollments e ON e.student_id = a.student_id AND e.subject_id = a.subject_id
JOIN students s    ON s.student_id = a.student_id
JOIN subjects sub  ON sub.subject_id = a.subject_id;

-- b) Performance view: average marks per student
CREATE OR REPLACE VIEW v_student_performance AS
SELECT
  s.student_id,
  s.student_name,
  s.class,
  ROUND(AVG(g.marks),2) AS avg_marks
FROM students s
JOIN grades g  ON g.student_id = s.student_id
GROUP BY s.student_id, s.student_name, s.class;

-- c) Overall summary: performance + overall attendance %
CREATE OR REPLACE VIEW v_overall_summary AS
SELECT
  p.student_id,
  p.student_name,
  p.class,
  p.avg_marks,
  ROUND(AVG(a.attendance_pct),2) AS avg_attendance_pct
FROM v_student_performance p
JOIN v_student_attendance a ON a.student_id = p.student_id
GROUP BY p.student_id, p.student_name, p.class, p.avg_marks;

-- ======================
-- 4) Index on student name (for faster lookups/sorts)
-- ======================
CREATE INDEX idx_students_name ON students(student_name);

-- ======================
-- 5) Demo queries (you can show these in output)
-- ======================
-- View attendance details
SELECT * FROM v_student_attendance ORDER BY student_name, subject_name;

-- View performance (avg marks per student)
SELECT * FROM v_student_performance ORDER BY avg_marks DESC;

-- Combined summary (avg marks + avg attendance %)
SELECT * FROM v_overall_summary ORDER BY avg_marks DESC, avg_attendance_pct DESC;

-- Show the index
SHOW INDEX FROM students;

-- Show that AUTO_INCREMENT ("sequence") works by inserting a new student
INSERT INTO students (student_name, class, address) VALUES ('Neha', 'SE', 'Pune');
SELECT student_id, student_name FROM students ORDER BY student_id;
